<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Class view</title>

    <script type="text/javascript">

      function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, '\\$&');
        var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
      }

      function createCORSRequest(method, url) {
        var xhr = new XMLHttpRequest();
        if ("withCredentials" in xhr) {
          xhr.open(method, url, true);
        } else if (typeof XDomainRequest != "undefined") {
          xhr = new XDomainRequest();
          xhr.open(method, url);
        } else {
          xhr = null;
        }
        return xhr;
      }

    </script>


    <style media="screen">
      th, td, table {
        border: 1px solid #ddd;
        border-spacing: 0px;
        border-collapse: collapse;
      }

      th {
        text-align: left;
      }

      th, td {
        padding: 15px;
        text-align: left;
      }

      .goal-title {
        display: inline-block;
        margin-right: 15px;
      }

      .goal-value {
        display: inline-block;
      }
    </style>
  </head>
  <body>
    <div class="" name="title-bar">
      <h1 id="name" style="padding-bottom: 0px; padding-top: 5px; margin: 0px">Horse Lounge</h1>
      <h2 id="idf" style="padding-top: 5px; margin: 0px">ID: awdawdawdawd</h2>

      <script type="text/javascript">
      let name = document.getElementById('name');
      let id = document.getElementById('idf');
      let currentClass;
      let currentUser;

      let xhr = createCORSRequest("GET", `http://18.220.203.155:8080/class?do=getClass&classID=${getParameterByName("id")}`);

        xhr.onload = function() {
          var responseText = xhr.responseText;
          let response = JSON.parse(responseText);

          if (response.id != getParameterByName("id")) {
            return console.log("id mismatch!");
          } else {
            currentClass = response;
            name.innerHTML = currentClass.name;
            id.innerHTML = `ID: ${currentClass.id}`;
          }

          for (let i = 0; i < currentClass.members.length; i++) {
            let member = currentClass.members[i];

            if (member.profile.username == localStorage.getItem("username")) {
              currentUser = member;
            }
          }

          setTable();
          loadGoals();

        }
        xhr.send();


      </script>
    </div>

    <div class="goal-tracker" style="margin-bottom:25px">

      <script type="text/javascript" name="goal-manager">

        let addButton;
        let goalTable;

        function loadGoals() {
          let goals = currentClass.settings[0].goals;

          goalTable = document.getElementById('goal-table');
          addButton = document.getElementById('add-goal');

          if (currentUser.teacher) {
            addButton.style = "inline-block;"
          } else {
            addButton.style = "none";
          }

          if (!goals) {
            return noGoals();
          }

          if (goals.length > 0) {
            for (let i = 0; i < goals.length; i++) {
              let g = goals[i];

              let row = goalTable.insertRow();
              if (g.goal_progress >= g.goal_points) {
                row.innerHTML = `\<p\>${g.goal_name}: Completed!\<p\>`
              } else {
                row.innerHTML = `\<p class="goal-title"\>${g.goal_name}   (${g.goal_progress} pts / ${g.goal_points} pts)\</p\> \<progress value="${Math.floor((Number(g.goal_progress) / g.goal_points) * 100)}" max="100" style="width: 100%" class="goal-value"\>\</progress\>\<br\>`
              }
            }
          } else {
            noGoals();
          }
        }

        function noGoals() {
          goalTable.insertRow().innerHTML = "No class goals.";
        }

        function addGoal() {
          let goalTitle = prompt("Enter your goal's title.");
          if (goalTitle == undefined || !goalTitle) {
            return alert("Failed");
          }

          let goalTarget = prompt("Enter your goal's required point gain.");
          if (goalTarget == undefined || !goalTarget || isNaN(Number(goalTarget))) {
            return alert("Failed");
          }

          let newGoal = {
            name: goalTitle,
            points: goalTarget
          }

          let xhr = createCORSRequest("POST", `http://18.220.203.155:8080/class?do=addGoal&classID=${currentClass.id}`);
          xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

          xhr.onload = function () {
            let response = xhr.responseText;

            if (response.toLowerCase() == "not found") {
              alert(`Failed to create goal!`);
            } else {
              alert(`Goal created succesfully!`);
            }
          }

          xhr.send(JSON.stringify(newGoal));
        }
      </script>

      <br>
      <h2 style="margin-bottom: 0px">Goals</h2> <button type="button" id="add-goal" onclick="addGoal()" style="display: none;">Add Goal</button>
      <table id="goal-table" style="width: 50%">
        <!-- <tr> Example goal display
          <p class="goal-title">Those pizzas   (750pts / 1500 pts)</p> <progress value="50" max="100" style="width: 25%" class="goal-value"></progress>
          <br>
        </tr> -->
      </table>
    </div>

    <table id="user-table">
      <tr>
        <th>Username</th>
        <th>Score</th>
      </tr>
    </table>
    <h2 style="margin-bottom: 0px">Activities</h2>
    <p style="margin-bottom: 0px">Complete these activities and submit your stories to earn points!</p>
    <br><div id="admin-buttons"><button type="button" name="button" style="display: inline-block" onclick="addActivity()">Add new activity</button><a type="button" name="button" style="display: inline-block" id="approve-button" href="../health-tracker/approve.html?classID">View activity requests (0 unread)</a></div><br>
    <table id="activity-table" style="display:inline-block">
      <tr>
        <th>Name</th>
        <th>Description</th>
        <th>Value</th>
        <th>Actions</th>
      </tr>
    </table>
    <div class="submit-activity" style="display:none" id="submit-panel">
      <em><p id="activity-name-box">name</p></em>
      <textarea rows="4" cols="50" placeholder="Enter the story which describes the activity you've completed." style="resize:none;" id="activity-story-box"></textarea><br>
      <button type="submit" name="button" onclick="submitActivity()">Submit</button>
    </div>

    <script type="text/javascript" name="table-manager">
      function setTable() {
        let usertable = document.getElementById('user-table');
        let activitytable = document.getElementById('activity-table');

        // for (let i = 0; i < currentClass.teachers.length; i++) {
        //   let row = usertable.insertRow();
        //
        //   row.insertCell(0).innerHTML = `<p style="color:red;">★ ${currentClass.teachers[i].nickname}</p>`;
        //   row.insertCell(1).innerHTML = `${currentClass.teachers[i].score} pts`;
        // }

        for (let i = 0; i < currentClass.members.length; i++) {
          let row = usertable.insertRow();
          let member = currentClass.members[i];
          if (member.teacher) {
            row.insertCell(0).innerHTML = `<p style="color:red;">★ ${member.nickname}</p>`;
          } else {
            row.insertCell(0).innerHTML = member.nickname;
          }

          row.insertCell(1).innerHTML = `${member.score} pts`;

          row.insertCell(2).innerHTML = `\<a href="../health-tracker/member.html?user=${member.profile.username}&id=${currentClass.id}"\>View history\</a\>`;
        }

        if (!currentUser.teacher) {
          adminPanel.style.display = "none";
        } else {
          approveButton.innerHTML = `View activity requests (${currentClass.approval_pool.length} unread)`
          approveButton.href = `../health-tracker/approve.html?id=${currentClass.id}`
        }

        console.log(currentClass.activities)
        for (let i = 0; i < currentClass.activities.length; i++) {
          let event = currentClass.activities[i];
          let row = activitytable.insertRow(1);

          row.insertCell(0).innerHTML = event.title;
          row.insertCell(1).innerHTML = event.details;
          row.insertCell(2).innerHTML = event.value + " points";
          let r3 = row.insertCell(3)
            r3.innerHTML = `\<button onclick=\"prepareActivity(${i})\"\>I did this\</button\>\<br\>`;
          if (currentUser.teacher) {
            r3.innerHTML += `\<button onclick=\"removeActivity(${i})\"\>Remove Activity\</button\>`
          }
        }
      }

      function addActivity() {
        let title = prompt("Provide an activity title.");
        if (title == null) return;

        let details = prompt("Enter activity details.\n(What a user must do to earn their points.)");
        if (details == null) return;

        let value = prompt("Enter activity value.\n(The points a user will receive upon completion.)");
        if (value == null) return;
        if (isNaN(Number(value))) {
          return alert("Aborted! Please provide a number value.");
        }

        let activity = {
          title: title,
          details: details,
          value: value
        }

        let xhr = createCORSRequest("POST", `http://18.220.203.155:8080/class?do=addActivity&classID=${currentClass.id}`);
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

        xhr.onload = function() {
          var responseText = xhr.responseText;
        }

        xhr.send(JSON.stringify(activity));
      }
    </script>

    <script type="text/javascript" id="activity-manager">
      let titleBox = document.getElementById('activity-name-box');
      let storyBox = document.getElementById('activity-story-box');

      let submitPanel = document.getElementById('submit-panel');
      let adminPanel = document.getElementById('admin-buttons');

      let approveButton = document.getElementById('approve-button');

      let selectedActivity;

      function prepareActivity(act) {
        submitPanel.style.display = "inline-block";
        selectedActivity = currentClass.activities[act];
        console.log(selectedActivity);
      }

      function removeActivity(act) {
        selectedActivity = currentClass.activities[act];
        console.log(selectedActivity);
        console.log(act);

        let xhr = createCORSRequest("POST", `http://18.220.203.155:8080/class?do=removeActivity&classID=${currentClass.id}&activityID=${act}`);

        xhr.onload = function() {
          console.log(`removed activity ${act}`);
        };

        xhr.send();
        location.reload();
      }

      function submitActivity() {
        let xhr = createCORSRequest("POST", `http://18.220.203.155:8080/class?do=submitActivity&classID=${currentClass.id}`);
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

        xhr.onload = function() {
          var responseText = xhr.responseText;

          if (responseText == "Created") {
            alert("Success!");
            submitPanel.style.display = "none";
          } else {
            alert("Failed to submit activity!");
          }

        }

        /*
          const activitySubmissionTemplate = {
            author: "Tuggi",
            story: "I did a walking",
            date: new Date(),
            approved: false
          }
        */

        let act = {
          author: currentUser.profile.username,
          story: storyBox.value,
          date: new Date(),
          activity: selectedActivity,
          approved: false
        }

        let temp = {
          water: "hole"
        }

        xhr.send(JSON.stringify(act));
      }
    </script>
  </body>
</html>
