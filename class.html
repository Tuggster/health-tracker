<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Class view</title>

    <script type="text/javascript">

      function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, '\\$&');
        var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
      }

      function createCORSRequest(method, url) {
        var xhr = new XMLHttpRequest();
        if ("withCredentials" in xhr) {
          xhr.open(method, url, true);
        } else if (typeof XDomainRequest != "undefined") {
          xhr = new XDomainRequest();
          xhr.open(method, url);
        } else {
          xhr = null;
        }
        return xhr;
      }

    </script>


    <style media="screen">
      th, td, table {
        border: 1px solid #ddd;
        border-spacing: 0px;
        border-collapse: collapse;
      }

      th {
        text-align: left;
      }

      th, td {
        padding: 15px;
        text-align: left;
      }
    </style>
  </head>
  <body>
    <div class="" name="title-bar">
      <h1 id="name" style="padding-bottom: 0px; padding-top: 5px; margin: 0px">Horse Lounge</h1>
      <h2 id="idf" style="padding-top: 5px; margin: 0px">ID: awdawdawdawd</h2>
      <script type="text/javascript">
      let name = document.getElementById('name');
      let id = document.getElementById('idf');
      let currentClass;
      let currentUser;

      let xhr = createCORSRequest("GET", `http://localhost:3000/class?do=getClass&classID=${getParameterByName("id")}`);

        xhr.onload = function() {
          var responseText = xhr.responseText;
          let response = JSON.parse(responseText);

          if (response.id != getParameterByName("id")) {
            return console.log("id mismatch!");
          } else {
            currentClass = response;
            name.innerHTML = currentClass.name;
            id.innerHTML = `ID: ${currentClass.id}`;
          }

          for (let i = 0; i < currentClass.members.length; i++) {
            let member = currentClass.members[i];

            if (member.profile.username == localStorage.getItem("username")) {
              currentUser = member;
            }
          }

          setTable();

        }
        xhr.send();


      </script>
    </div>

    <table id="user-table">
      <tr>
        <th>Username</th>
        <th>Score</th>
      </tr>
    </table>
    <br><div id="admin-buttons"><button type="button" name="button" style="display: inline-block" onclick="addActivity()">Add new activity</button><a type="button" name="button" style="display: inline-block" id="approve-button" href="../client/approve.html?classID">View activity requests (0 unread)</a></div><br>
    <table id="activity-table" style="display:inline-block">
      <tr>
        <th>Name</th>
        <th>Description</th>
        <th>Value</th>
        <th>Actions</th>
      </tr>
    </table>
    <div class="submit-activity" style="display:none" id="submit-panel">
      <em><p id="activity-name-box">name</p></em>
      <textarea rows="4" cols="50" placeholder="Enter the story which describes the activity you've completed." style="resize:none;" id="activity-story-box"></textarea><br>
      <button type="submit" name="button" onclick="submitActivity()">Submit</button>
    </div>

    <script type="text/javascript" name="table-manager">
      function setTable() {
        let usertable = document.getElementById('user-table');
        let activitytable = document.getElementById('activity-table');

        // for (let i = 0; i < currentClass.teachers.length; i++) {
        //   let row = usertable.insertRow();
        //
        //   row.insertCell(0).innerHTML = `<p style="color:red;">★ ${currentClass.teachers[i].nickname}</p>`;
        //   row.insertCell(1).innerHTML = `${currentClass.teachers[i].score} pts`;
        // }

        for (let i = 0; i < currentClass.members.length; i++) {
          let row = usertable.insertRow();
          let member = currentClass.members[i];
          if (member.teacher) {
            row.insertCell(0).innerHTML = `<p style="color:red;">★ ${member.nickname}</p>`;
          } else {
            row.insertCell(0).innerHTML = member.nickname;
          }

          row.insertCell(1).innerHTML = `${member.score} pts`;

          if (currentUser.teacher) {
            row.insertCell(2).innerHTML = `promote\nkick\ngive points`;
          }
        }

        if (!currentUser.teacher) {
          adminPanel.style.display = "none";
        } else {
          approveButton.innerHTML = `View activity requests (${currentClass.approval_pool.length} unread)`
          approveButton.href = `../client/approve.html?id=${currentClass.id}`
        }

        console.log(currentClass.activities)
        for (let i = 0; i < currentClass.activities.length; i++) {
          let event = currentClass.activities[i];
          let row = activitytable.insertRow(1);

          row.insertCell(0).innerHTML = event.title;
          row.insertCell(1).innerHTML = event.details;
          row.insertCell(2).innerHTML = event.value + " points";
          row.insertCell(3).innerHTML = `\<button onclick=\"prepareActivity(${i})\"\>I did this\</button\>`;
        }
      }

      function addActivity() {
        let title = prompt("Provide an activity title.");
        if (title == null) return;

        let details = prompt("Enter activity details.\n(What a user must do to earn their points.)");
        if (details == null) return;

        let value = prompt("Enter activity value.\n(The points a user will receive upon completion.)");
        if (details == null) return;

        let activity = {
          title: title,
          details: details,
          value: value
        }

        let xhr = createCORSRequest("POST", `http://localhost:3000/class?do=addActivity&classID=${currentClass.id}`);
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

        xhr.onload = function() {
          var responseText = xhr.responseText;
        }

        xhr.send(JSON.stringify(activity));
      }
    </script>

    <script type="text/javascript" id="activity-manager">
      let titleBox = document.getElementById('activity-name-box');
      let storyBox = document.getElementById('activity-story-box');

      let submitPanel = document.getElementById('submit-panel');
      let adminPanel = document.getElementById('admin-buttons');

      let approveButton = document.getElementById('approve-button');

      let selectedActivity;

      function prepareActivity(act) {
        submitPanel.style.display = "inline-block";
        selectedActivity = currentClass.activities[act];
        console.log(selectedActivity);
      }

      function submitActivity() {
        let xhr = createCORSRequest("POST", `http://localhost:3000/class?do=submitActivity&classID=${currentClass.id}`);
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

        xhr.onload = function() {
          var responseText = xhr.responseText;

          if (responseText == "Created") {
            alert("Success!");
            submitPanel.style.display = "none";
          } else {
            alert("Failed to submit activity!");
          }

        }

        /*
          const activitySubmissionTemplate = {
            author: "Tuggi",
            story: "I did a walking",
            date: new Date(),
            approved: false
          }
        */

        let act = {
          author: currentUser.nickname,
          story: storyBox.value,
          date: new Date(),
          activity: selectedActivity,
          approved: false
        }

        let temp = {
          water: "hole"
        }

        xhr.send(JSON.stringify(act));
      }
    </script>
  </body>
</html>
