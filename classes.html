<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Class Management</title>
    <style media="screen">
      th, td {
        border-bottom: 1px solid #ddd;
        border-left: 1px solid #ddd;
      }

      th {
        text-align: left;
      }

      th, td {
        padding: 15px;
        text-align: left;
      }

      .class-container {
        width: 300px;
        border-style: solid;
        border-color: rgb(25, 25, 25, 0.25);
      }

      a {color:#190000;}      /* unvisited link */
      a:visited {color:#190000;}  /* visited link */
      a:hover {color:#FF00FF;}  /* mouse over link */
      a:active {color:#190000;}  /* selected link */
    </style>


  </head>
  <body>
    <h2 style="float: right; display: inline-block; padding-left: 20px;"><button onclick="createClass()">Create class</button></h2>
    <h2 style="float: right; display: inline-block; padding-left: 20px;"><button onclick="joinClass()">Join class</button></h2>

    <!-- <table class="class-table" id="tab">
      <tr>
        <th>Class name</th>
        <th>Member count</th>
        <th>Controls</th>
      </tr>
    </table> -->

    <div class="classes" id="classes">
      <!-- <div class="class-container">
        <h1 style="padding-bottom: 0px; padding-top: 0px; margin: 0px">Waterhole VII</h1>
        <h2 style="padding-bottom: 0px; padding-top: 0px; margin: 0px">5 members - 1200 points</h2>
      </div> -->
    </div>


    <script type="text/javascript">

      let href = location.href;
      let url = href.replace(/(^\w+:|^)\/\//, '');

      function createCORSRequest(method, url) {
        var xhr = new XMLHttpRequest();
        if ("withCredentials" in xhr) {
          xhr.open(method, url, true);
        } else if (typeof XDomainRequest != "undefined") {
          xhr = new XDomainRequest();
          xhr.open(method, url);
        } else {
          xhr = null;
        }
        return xhr;
      }

      let username = localStorage.getItem("username");
      let table = document.getElementById('tab');

      let classDiv = document.getElementById(`classes`);

      if (username) {
        getClasses();
      }

      function createClass() {
        let className = prompt("Enter your class's name.");

        if (className == null) {
          return;
        } else {
          if (className == "") {
            createClass();
            return;
          }
        }

        let xhr = createCORSRequest("POST", "http://18.220.203.155:8080/class");
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

        let classData = {
          className: "defaultClass",
          username: "user",
          do: "createClass"
        }

        classData.className = className;
        classData.username = username;

        xhr.onload = function() {
          var responseText = xhr.responseText;

          if (Number(responseText) == 201)
            alert("done good")

          location.reload();
        };

        xhr.send(JSON.stringify(classData));
      }

      function joinClass() {
        let id = prompt("Enter the ID for the class you're joining.");

        if (id == null) {
          return;
        } else if (id == "") {
          return joinClass();
        } else {
          let xhr = createCORSRequest("POST", "http://18.220.203.155:8080/class");
          xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

          xhr.onload = function() {
            let response = xhr.responseText;
            if (Number(response) == 200) {
              console.log("Joined new class!");
            }

            location.reload();

          }

          let msg = {
              classID: 14234213412312412,
              username: "Tuggi",
              do: "joinClass"
          }

          msg.classID = id;
          msg.username = username;
          xhr.send(JSON.stringify(msg));
        }

      }

      function getClasses() {
        let xhr = createCORSRequest("GET", `http://18.220.203.155:8080/class?do=getClasses&username=${username}`);

        xhr.onload = function() {
          var responseText = xhr.responseText;
          let response = JSON.parse(responseText);
          let servers = response.classes;
          console.log(response);

          for (let i = 0; i < servers.length; i++) {
            // let row = table.insertRow();
            // row.insertCell(0).innerHTML = servers[i].name;
            // row.insertCell(1).innerHTML = servers[i].members.length;


            let link;
            if (!url.startsWith(`18.220`)) {
              link = `../health-tracker/class.html?id=${servers[i].id}`;
            } else {
              link = `../class.html?id=${servers[i].id}`;
            }

            let user;
            for (let j = 0; j < servers[i].members.length; j++) {
              if (servers[i].members[j].profile.username == username)
                user = servers[i].members[j];
            }

            let closesGoal;
            let largest = 0;

            if (servers[i].settings[0].goals.length > 0) {

              for (let j = 0; j < servers[i].settings[0].goals.length; j++) {
                let goal = servers[i].settings[0].goals[j];
                let percent = (goal.goal_progress / goal.goal_points) * 100
                if (percent > largest && percent < 100) {
                  largest = Math.floor(percent);
                }
              }
            }


            let entry = `
            \<div class="class-container"\>
              \<a href="${link}"\>\<h1 style="padding-bottom: 0px; padding-top: 0px; margin: 0px"\>${servers[i].name}\</h1\>\</a\>
              \<h2 style="padding-bottom: 0px; padding-top: 0px; margin: 0px"\>${servers[i].members.length} members - ${user.score} points\</h2\>
              \<h2 style="padding-bottom: 0px; padding-top: 0px; margin: 0px"\>Closest goal: ${largest}%\</h2\>

            \</div\>
            `

            classDiv.innerHTML += entry;
          }

        }

        xhr.send();
      }
    </script>
  </body>
</html>
